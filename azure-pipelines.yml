trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  TF_VERSION: '1.7.5'
  AZURE_SERVICE_CONNECTION_NAME: 'ADO'
  TF_WORKING_DIR: '$(System.DefaultWorkingDirectory)'

stages:
- stage: InitPlan
  displayName: 'Terraform Init and Plan'
  jobs:
    - job: InitPlanJob
      displayName: 'Terraform Init and Plan Job'
      steps:
        - task: UseTerraform@0
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '$(TF_VERSION)'
        - task: TerraformTaskV4@4
          displayName: 'Terraform Init'
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(TF_WORKING_DIR)'
            backendServiceArm: '$(AZURE_SERVICE_CONNECTION_NAME)'
        - task: TerraformTaskV4@4
          displayName: 'Terraform Plan'
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(TF_WORKING_DIR)'
            environmentServiceNameAzureRM: '$(AZURE_SERVICE_CONNECTION_NAME)'

- stage: Approval
  displayName: 'Manual Approval'
  dependsOn: InitPlan
  jobs:
    - deployment: WaitForApproval
      displayName: 'Approval Before Apply'
      environment: 'Approvals'
      strategy:
        runOnce:
          deploy:
            steps:
              - script: echo "Waiting for approval before proceeding to Terraform Apply"
                displayName: 'Approval Step'

- stage: Apply
  displayName: 'Terraform Apply'
  dependsOn: Approval
  jobs:
    - job: ApplyJob
      displayName: 'Terraform Apply Job'
      steps:
        - task: UseTerraform@0
          displayName: 'Install Terraform'
          inputs:
            terraformVersion: '$(TF_VERSION)'
        - task: TerraformTaskV4@4
          displayName: 'Terraform Apply'
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(TF_WORKING_DIR)'
            environmentServiceNameAzureRM: '$(AZURE_SERVICE_CONNECTION_NAME)'
            args: '-auto-approve'
            allowTelemetryCollection: false